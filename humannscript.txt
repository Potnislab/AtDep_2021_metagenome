Humann analysis for maaslin2

First the human output tables were normalized using cpm for both the pathabundance and gene families

#!/bin/bash
for SAMPLE in ./*_pathabundance.tsv; do
    humann_renorm_table --input $SAMPLE --output ${SAMPLE%.tsv}_cpm.tsv --units cpm --update-snames

done


#!/bin/bash
for SAMPLE in ./*_genefamilies.tsv; do
    humann_renorm_table --input $SAMPLE --output ${SAMPLE%.tsv}_cpm.tsv --units cpm --update-snames
done


For Maaslin2 the values should be in relative abundance instead of cpm so we normalized them based on relab
#!/bin/bash
for SAMPLE in ./*_genefamilies.tsv; do
    humann_renorm_table --input $SAMPLE --output ${SAMPLE%.tsv}_relab.tsv --units relab --update-snames
done

#!/bin/bash
for SAMPLE in ./*_pathabundance.tsv; do
    humann_renorm_table --input $SAMPLE --output ${SAMPLE%.tsv}_relab.tsv --units relab --update-snames
done


Then the tables are joined together 

humann_join_tables --input . --output humann_genefamiliesrealb.tsv --file_name genefamilies_relab

humann_join_tables --input . --output humann_pathabundancerealb.tsv --file_name pathabundance_relab


Now to have the gene and path abundacne based on families i reformatted the tables (needs to be through loop)

humann_regroup_table -i humann3_genefamilies.tsv -g uniref90_ko -o humann_genefam_ko.tsv




New analysis
all gene and path files are kept in newfolder and the tables are joined ( i removed base and 7em and 8em samples)
humann_join_tables --input . --output chioma_genefamilies.tsv --file_name genefamilies

humann_join_tables --input . --output chioma_pathabundance.tsv --file_name pathabundance

humann_split_stratified_table --input chioma_genefamilies.tsv --output chioma_genefamilies

humann_split_stratified_table --input chioma_pathabundance.tsv --output chioma_pathabundance

#renorm script should be submitted in queue
humann_renorm_table --input chioma_genefamilies.tsv --output chioma_genefamilies_cpm.tsv --units cpm

humann_renorm_table --input chioma_pathabundance.tsv --output chioma_pathabundance_relab.tsv --units relab


humann_split_stratified_table --input chioma_genefamilies_cpm.tsv --output chioma_genefamilies_cpm

humann_split_stratified_table --input chioma_pathabundance_relab.tsv --output chioma_pathabundance_relab

#run regroup in queue
humann_regroup_table --input chioma_genefamilies.tsv --custom /home/aubrrb/humann_database/utility_mapping/map_ko_uniref90.txt.gz  \
--output chioma_genefamilies_ko.tsv


humann_renorm_table --input chioma_genefamilies_ko.tsv --output chioma_genefamilies_ko_cpm.tsv --units cpm

humann_split_stratified_table --input chioma_genefamilies_ko_cpm.tsv --output .

humann_split_stratified_table --input chioma_genefamilies_ko.tsv --output .


#run in quueue

humann_regroup_table --input chioma_genefamilies.tsv --groups uniref90_eggnog  \
--output chioma_genefamilies_cog.tsv


humann_renorm_table --input chioma_genefamilies_cog.tsv --output chioma_genefamilies_cog_cpm.tsv --units cpm

humann_split_stratified_table --input chioma_genefamilies_cog_cpm.tsv --output .

humann_split_stratified_table --input chioma_genefamilies_cog.tsv --output .


#We then import data into QIIME2 (v.2020.6) to calculate alpha and beta diversity indices.
#!/bin/bash
source activate qiime

biom convert -i /scratch/aubrrb/atdep_humann3/newfolder/chioma_pathabundance/chioma_pathabundance_unstratified.tsv \
-o ./chioma_pathabundance_unstratified.biom \
--table-type "Pathway table" --to-hdf5

biom convert -i /scratch/aubrrb/atdep_humann3/newfolder/chioma_genefamilies_ko_unstratified.tsv \
-o ./chioma_genefamilies_ko_unstratified.biom \
--table-type="OTU table" --to-hdf5

biom convert -i /scratch/aubrrb/atdep_humann3/newfolder/chioma_genefamilies_cog_unstratified.tsv \
-o ./chioma_genefamilies_cog_unstratified.biom \
--table-type="OTU table" --to-hdf5

biom summarize-table -i ./chioma_pathabundance_unstratified.biom \
-o ./chioma_pathabundance_unstratified_summary.txt


biom summarize-table -i ./chioma_genefamilies_ko_unstratified.biom \
-o ./chioma_genefamilies_ko_unstratified_summary.txt

biom summarize-table -i ./chioma_genefamilies_cog_unstratified.biom \
-o ./chioma_genefamilies_cog_unstratified_summary.txt


#then convert the biom file into .qza file which are the files for qiime

#!/bin/bash
source activate qiime2
qiime tools import \
--input-path chioma_pathabundance_unstratified.biom \
--type 'FeatureTable[Frequency]' \
--input-format BIOMV210Format \
--output-path chioma_pathabundance_unstratified.qza


#!/bin/bash
source activate qiime2
qiime tools import \
--input-path /scratch/aubrrb/atdep_humann3/newfolder/chioma_genefamilies_ko_unstratified.biom \
--type 'FeatureTable[Frequency]' \
--input-format BIOMV210Format \
--output-path chioma_genefamilies_ko_unstratified.qza



#!/bin/bash
source activate qiime2 
qiime tools import \
--input-path /scratch/aubrrb/atdep_humann3/newfolder/chioma_genefamilies_cog_unstratified.biom \
--type 'FeatureTable[Frequency]' \
--input-format BIOMV210Format \
--output-path /scratch/aubrrb/atdep_humann3/newfolder/chioma_genefamilies_cog_unstratified.qza


#!/bin/bash
source activate qiime2
qiime feature-table filter-features \
--i-table chioma_pathabundance_unstratified.qza \
--p-min-samples 2 \
--o-filtered-table chioma_pathabundance_unstratified.qza


qiime tools export \
--input-path temp2.qzachioma_pathabundance_unstratified.qza \
--output-path collapse.frequency/



#Here i rarefied the total samples based on the lowest possibtle number 

#!/bin/bash
source activate qiime2
qiime diversity core-metrics \
--i-table chioma_pathabundance_unstratified.qza \
--p-sampling-depth  2454811 \
--m-metadata-file chioma_Sept20_metadata_pa.txt \
--output-dir chioma_pathabundance_unstratified

#to see what do we have in the qza file we have to first convert .qza to biom and then to tsv
qiime tools export --input-path chioma_genefamilies_ko_unstratified.qza --output-path exported-feature-table

biom convert -i feature-table.biom -o table.from_biom.txt --to-tsv


#!/bin/bash
source activate qiime2 
qiime diversity core-metrics \
--i-table chioma_genefamilies_ko_unstratified.qza \
--p-sampling-depth 5774881 \
--m-metadata-file chioma_Sept20_metadata_gf.txt \
--output-dir chioma_genefamilies_unstratified



#!/bin/bash
source activate qiime2
qiime diversity core-metrics \
--i-table chioma_genefamilies_cog_unstratified.qza \
--p-sampling-depth 6103171 \
--m-metadata-file chioma_Sept20_metadata_gf.txt \
--output-dir chioma_genefamilies_cog_unstratified


#Now export the distance matrix from qza so we can use them with R
#!/bin/bash
source activate qiime2
qiime tools export \
--input-path ./chioma_pathabundance_unstratified/bray_curtis_distance_matrix.qza \
--output-path bray-curtis-distance-matrix-pa


#!/bin/bash
source activate qiime2
qiime tools export \
--input-path ./chioma_pathabundance_unstratified/jaccard_distance_matrix.qza \
--output-path jaccard-distance-matrix-pa

#!/bin/bash
source activate qiime2
qiime tools export \
--input-path ./chioma_genefamilies_cog_unstratified/bray_curtis_distance_matrix.qza \
--output-path bray-curtis-distance-matrix-cog

#!/bin/bash
source activate qiime2
qiime tools export \
--input-path ./chioma_genefamilies_cog_unstratified/jaccard_distance_matrix.qza \
--output-path jaccard-distance-matrix-cog

#!/bin/bash
source activate qiime2
qiime tools export \
--input-path ./chioma_genefamilies_unstratified/bray_curtis_distance_matrix.qza \
--output-path bray-curtis-distance-matrix-gf

#!/bin/bash
source activate qiime2
qiime tools export \
--input-path ./chioma_genefamilies_unstratified/jaccard_distance_matrix.qza \
--output-path jaccard-distance-matrix-gf




glmmTMB(Unmapped ~ cultivar + environment, data = paths_meta, family = nbinom2)



LEFSE
When I install lefse with conda, I found that it conflicted with the newest python3.9. I found it should be installed in the environment (python3.7) which it could be pre created.
{
conda create -n lefse -c bioconda python=2.7
conda activate lefse
conda install -c bioconda lefse
}



# Filter features that only appear in a single sample
qiime feature-table filter-features \
--i-table chioma_pathabundance_unstratified.qza \
--p-min-samples 2 \
--o-filtered-table temp2.qza

# Filter features by reads
qiime feature-table filter-features \
--i-table temp2.qza \
--p-min-frequency 10 \
--o-filtered-table temp3.qza


qiime tools export \
  --input-path temp3.qza \
  --output-path pathabundance-feature-table


Then convert from qiime to lefse with the following 
https://github.com/statonlab/BiGG2020_CrackNAg/wiki/qiime2-to-lefse


biom convert -i chioma_pathabundance_relab_unstratified.tsv \
-o ./chioma_pathabundance_relab_unstratified.biom \
--table-type "Pathway table" --to-hdf5


#!/bin/bash
source activate qiime2
qiime tools import \
--input-path chioma_pathabundance_relab_unstratified.biom \
--type 'FeatureTable[Frequency]' \
--input-format BIOMV210Format \
--output-path chioma_pathabundance_relab_unstratified.qza


#!/bin/bash
source activate qiime2
qiime feature-table filter-features \
--i-table chioma_pathabundance_relab_unstratified.qza \
--p-min-samples 2 \
--o-filtered-table temp2.qza

qiime tools export \
--input-path bray_curtis_distance_matrix.qza \
--output-path collapse.frequency/



biom convert -i feature-table.biom -o table.from_biom.txt --to-tsv




#https://github.com/emallott/PulmonaryFibrosisMicrobiome/blob/master/Command%20line%20analyses.ipynb 

#!/bin/bash
source activate qiime2
qiime feature-table filter-samples --i-table chioma_pathabundance_unstratified.qza \
--m-metadata-file chioma_Sept20_metadata_pa.txt \
--p-where "[cultivar]='X10R'" \
--o-filtered-table ECW_pathabundance_unstratified_filtered.qza

qiime feature-table filter-samples \
  --i-table table.qza \
  --m-metadata-file sample-metadata.tsv \
  --p-where "[cultivar]='X10R'" \
  --o-filtered-table subject-1-filtered-table.qza


#!/bin/bash
source activate qiime2
qiime tools export \
--input-path ./ECW_pathabundance_unstratified/jaccard_distance_matrix.qza \
--output-path ECWjaccard_distance_matrix.pa


